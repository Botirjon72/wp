<!DOCTYPE html>
<html lang="uz">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Poxoyfusk</title>
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Rajdhani:wght@400;700&display=swap');
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    body {
      min-height: 100vh;
      font-family: 'Rajdhani', sans-serif;
      background: #000;
      display: flex;
      flex-direction: column;
      align-items: center;
      padding: 20px;
    }
    h1 {
      font-size: 32px;
      color: #0ff;
      text-shadow: 0 0 10px #0ff;
      margin-bottom: 20px;
    }
    .grid-container {
      display: grid;
      grid-template-columns: repeat(5, 60px);
      grid-gap: 10px;
      margin-bottom: 20px;
    }
    .crystal {
      background: linear-gradient(135deg, #0ff, #00f);
      border: 2px solid #0ff;
      border-radius: 10px;
      height: 60px;
      width: 60px;
      box-shadow: 0 0 10px #0ff, inset 0 0 5px #00f;
      transition: transform 0.2s;
      cursor: pointer;
    }
    .crystal:hover {
      transform: scale(1.05);
    }
    .crystal.revealed {
      background: #002a33;
      box-shadow: inset 0 0 5px #0ff;
      color: #0ff;
      font-size: 24px;
      font-weight: bold;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    .crystal.mine {
      background: #ff0033 !important;
      color: #fff;
      box-shadow: 0 0 10px red;
    }
    .crystal.yutuq {
      background: #003300 !important;
      box-shadow: 0 0 8px lime;
    }
    .bet-controls {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 15px;
    }
    .bet-options {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      justify-content: center;
    }
    .bet-btn {
      padding: 8px 16px;
      background: #111;
      color: #0ff;
      border: 1px solid #0ff;
      border-radius: 6px;
      cursor: pointer;
      font-weight: bold;
      transition: all 0.2s;
    }
    .bet-btn:hover {
      background: #0ff;
      color: #000;
    }
    #customBet {
      padding: 8px;
      border-radius: 6px;
      border: 1px solid #0ff;
      background: #000;
      color: #0ff;
      width: 140px;
      text-align: center;
    }
    .action-buttons {
      display: flex;
      gap: 10px;
      justify-content: center;
      flex-wrap: wrap;
      margin-bottom: 30px;
    }
    #startButton,
    #cashoutButton {
      padding: 10px 20px;
      font-size: 16px;
      border: none;
      border-radius: 6px;
      background: #0ff;
      color: #000;
      cursor: pointer;
      font-weight: bold;
      box-shadow: 0 0 8px #0ff;
      transition: background 0.3s;
    }
    #startButton:hover,
    #cashoutButton:hover {
      background: #00e6e6;
    }
    #startButton:disabled,
    #cashoutButton:disabled {
      background: #444;
      color: #aaa;
      box-shadow: none;
      cursor: not-allowed;
    }
    .user-info {
      display: flex;
      margin: 20px;
      justify-content: space-between;
      flex-wrap: wrap;
      color: #fff;
      gap: 10px;
      padding-bottom: 15px;
      border-bottom: 1px solid #0ff;
      align-items: center;
      width: 90%;
      max-width: 600px;
    }
    .user-profile {
      display: flex;
      align-items: center;
      gap: 10px;
    }
    .avatar {
      width: 50px;
      height: 50px;
      border-radius: 50%;
      border: 2px solid #0ff;
    }
    .user-info h3 {
      color: #0ff;
      font-size: 24px;
    }
    .user-info p {
      margin: 5px 0 0;
      font-size: 14px;
      opacity: 0.8;
    }
    footer.footer {
      position: fixed;
      bottom: 0;
      left: 0;
      width: 100%;
      padding: 20px;
      background: rgba(0, 0, 0, 0.7);
      text-align: center;
      color: #fff;
      font-size: 13px;
      border-top: 1px solid #0ff;
      z-index: 3;
      backdrop-filter: blur(5px);
    }
    #currentWin {
      color: #0ff;
      font-size: 18px;
      margin-bottom: 10px;
    }
    /* Notification effekti */
    .notification {
      position: fixed;
      top: 20px;
      right: 20px;
      background: linear-gradient(135deg, #0ff, #0f0);
      color: #000;
      padding: 15px 25px;
      border-radius: 10px;
      font-weight: 600;
      z-index: 2000;
      transform: translateX(400px);
      transition: transform 0.3s ease;
      box-shadow: 0 10px 25px rgba(0, 255, 255, 0.4);
    }
    .notification.show {
      transform: translateX(0);
    }
    .notification.error {
      background: linear-gradient(135deg, #ff4444, #ff6666);
      color: #fff;
    }
    @media (max-width: 500px) {
      .grid-container {
        grid-template-columns: repeat(5, 48px);
      }
      .crystal {
        width: 48px;
        height: 48px;
      }
      h1 {
        font-size: 24px;
      }
      .user-info h3 {
        font-size: 20px;
      }
      .bet-btn, #customBet {
        font-size: 14px;
        padding: 6px 12px;
      }
    }
  </style>
</head>
<body>
  <div class="user-info">
    <div class="user-profile">
      <img id="avatar" src="./img/default.jpg" alt="Avatar" class="avatar">
      <div>
        <h3 id="name">Yuklanmoqda...</h3>
        <p id="level">--</p>
        <p id="xp">--</p>
      </div>
    </div>
    <div>
      <p id="rank">--</p>
      <p id="coins">Tanga: --</p>
    </div>
  </div>

  <h1>Poxoyfusk Kristallar</h1>
  <p id="multiplier">Ko‚Äòpaytiruvchi: 1.0x</p>
  <div class="grid-container" id="crystalGrid"></div>
  <p id="currentWin">Joriy yutuq: 0 tanga</p>
  <div class="bet-controls">
    <div class="bet-options">
      <button class="bet-btn" data-amount="300">Min (300)</button>
      <button class="bet-btn" data-amount="5000">Max (5000)</button>
      <button class="bet-btn" data-amount="600">2x (600)</button>
      <button class="bet-btn" data-amount="1500">5x (1500)</button>
      <input type="number" id="customBet" placeholder="Tanga miqdori..." min="100" step="100" />
    </div>
    <div class="action-buttons">
      <button id="startButton">üé∞ Garov Tikish</button>
      <button id="cashoutButton" disabled>üí∞ Garovni Olish</button>
    </div>
  </div>

  <footer class="footer">REKLAMA</footer>

  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <script>
    const STORAGE_KEYS = {
      USER_DATA: 'poxoyfusk_user_data'
    };

    const tg = window.Telegram?.WebApp;
    tg?.ready();
    tg?.expand();

    const userId = tg?.initDataUnsafe?.user?.id;
    let userBalance = 0;

    // Notification ko‚Äòrsatish funksiyasi
    function showNotification(message, type = 'success') {
      const notification = document.createElement('div');
      notification.className = `notification ${type}`;
      notification.textContent = message;
      document.body.appendChild(notification);
      setTimeout(() => notification.classList.add('show'), 100);
      setTimeout(() => {
        notification.classList.remove('show');
        setTimeout(() => document.body.removeChild(notification), 300);
      }, 3000);
    }

    // Foydalanuvchi ma'lumotlarini olish
    async function fetchUserData() {
      // localStorage'dan ma'lumotlarni o'qish
      const savedData = localStorage.getItem(STORAGE_KEYS.USER_DATA);
      if (savedData) {
        const userData = JSON.parse(savedData);
        userBalance = userData.coins || 0;
        document.getElementById('name').textContent = userData.name || 'Noma ºlum';
        document.getElementById('level').textContent = `Level: ${userData.level}`;
        document.getElementById('xp').textContent = `XP: ${userData.xp}`;
        document.getElementById('rank').textContent = `Rank: ${userData.rank} | Score: ${userData.score}`;
        document.getElementById('coins').textContent = `Tanga: ${userData.coins}`;
        document.getElementById('avatar').src = userData.avatar?.trim() || './img/default.jpg';
      }

      if (!userId) {
        document.getElementById('name').textContent = 'Telegram ID topilmadi!';
        document.getElementById('avatar').src = './img/default.jpg';
        showNotification('‚ùå Telegram ID topilmadi!', 'error');
        return;
      }

      try {
        const res = await fetch(`/api/user?telegram_id=${userId}`);
        if (!res.ok) throw new Error(`HTTP xato: ${res.status}`);
        const data = await res.json();
        const userData = {
          name: data.name || 'Noma ºlum',
          level: data.level || 0,
          xp: data.xp || 0,
          rank: data.rank || 'N/A',
          score: data.score || 0,
          coins: data.coins || 0,
          avatar: data.avatar?.trim() || './img/default.jpg'
        };
        userBalance = userData.coins;
        document.getElementById('name').textContent = userData.name;
        document.getElementById('level').textContent = `Level: ${userData.level}`;
        document.getElementById('xp').textContent = `XP: ${userData.xp}`;
        document.getElementById('rank').textContent = `Rank: ${userData.rank} | Score: ${userData.score}`;
        document.getElementById('coins').textContent = `Tanga: ${userData.coins}`;
        document.getElementById('avatar').src = userData.avatar;
        localStorage.setItem(STORAGE_KEYS.USER_DATA, JSON.stringify(userData));
        console.log("Foydalanuvchi ma'lumotlari yuklandi:", userData);
      } catch (err) {
        console.error('Foydalanuvchi ma ºlumotlari xatosi:', err);
        document.getElementById('name').textContent = 'Xatolik!';
        document.getElementById('avatar').src = './img/default.jpg';
        showNotification('‚ùå Ma\'lumotlarni yuklashda xato yuz berdi!', 'error');
      }
    }

    // Balansni serverda yangilash
    async function updateBalanceOnServer(amount) {
      console.log("Balans yangilash so'rovi:", amount);
      try {
        const res = await fetch('/api/update-balance', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ telegram_id: userId, amount })
        });
        if (!res.ok) throw new Error(`HTTP xato: ${res.status}`);
        const data = await res.json();
        if (typeof data.newScore !== 'number') throw new Error('Noto‚Äòg‚Äòri server javobi');
        userBalance = data.newScore;
        document.getElementById('coins').textContent = `Tanga: ${userBalance}`;
        // localStorage'ni yangilash
        const savedData = localStorage.getItem(STORAGE_KEYS.USER_DATA);
        if (savedData) {
          const userData = JSON.parse(savedData);
          userData.coins = userBalance;
          localStorage.setItem(STORAGE_KEYS.USER_DATA, JSON.stringify(userData));
        }
        console.log("Balans yangilandi:", userBalance);
        return userBalance;
      } catch (err) {
        console.error("Balans yangilashda xato:", err);
        showNotification('‚ùå Balansni yangilashda xato yuz berdi!', 'error');
        throw err;
      }
    }

    const grid = document.getElementById('crystalGrid');
    const startButton = document.getElementById('startButton');
    const cashoutButton = document.getElementById('cashoutButton');
    const customBetInput = document.getElementById('customBet');
    const betButtons = document.querySelectorAll('.bet-btn');
    const multiplierDisplay = document.getElementById('multiplier');
    const currentWinDisplay = document.getElementById('currentWin');

    const total = 25;
    const minesCount = 5; // 20% mina
    let isGameActive = false;
    let revealedCount = 0;
    let selectedBet = 0;
    let mineIndexes = new Set();

    function renderGrid(disabled = true, mines = new Set()) {
      grid.innerHTML = '';
      for (let i = 0; i < total; i++) {
        const div = document.createElement('div');
        div.classList.add('crystal');
        div.dataset.index = i;
        div.dataset.mine = mines.has(i) ? 'true' : 'false';
        if (disabled) div.style.pointerEvents = 'none';
        grid.appendChild(div);
      }
    }

    function calculateMultiplier(revealed) {
      return (1 + revealed * 0.1).toFixed(2); // Ko‚Äòpaytiruvchi kamaytirildi
    }

    function updateCurrentWin() {
      const multiplier = parseFloat(calculateMultiplier(revealedCount));
      const currentWin = Math.round(selectedBet * multiplier);
      currentWinDisplay.textContent = `Joriy yutuq: ${currentWin} tanga`;
    }

    async function startGame() {
      if (isGameActive) {
        showNotification('‚ö†Ô∏è O‚Äòyin allaqachon boshlangan!', 'error');
        return;
      }

      const val = parseInt(customBetInput.value);
      if (isNaN(val) || val < 300) {
        showNotification('‚ö†Ô∏è 300 tangadan kam bo‚Äòlmagan garov kiriting!', 'error');
        return;
      }

      if (val > userBalance) {
        showNotification('‚ùå Mablag‚Äò yetmaydi!', 'error');
        return;
      }

      selectedBet = val;

      try {
        userBalance -= selectedBet;
        await updateBalanceOnServer(userBalance);
      } catch (err) {
        userBalance += selectedBet; // Xato bo‚Äòlsa, stavkani qaytarish
        showNotification(`Garov tikishda xatolik: ${err.message}`, 'error');
        return;
      }

      mineIndexes.clear();
      while (mineIndexes.size < minesCount) {
        mineIndexes.add(Math.floor(Math.random() * total));
      }

      isGameActive = true;
      startButton.disabled = true;
      cashoutButton.disabled = false;
      renderGrid(false, mineIndexes);
      updateCurrentWin();

      const crystals = document.querySelectorAll('.crystal');
      crystals.forEach(div => {
        div.addEventListener('click', () => {
          if (!isGameActive || div.classList.contains('revealed')) return;

          div.classList.add('revealed');
          if (div.dataset.mine === 'true') {
            div.classList.add('mine');
            div.textContent = 'üí£';
            isGameActive = false;
            cashoutButton.disabled = true;
            startButton.disabled = false;
            setTimeout(() => {
              showNotification('üí• Mina bosildi! O‚Äòyin tugadi.', 'error');
              resetGame();
            }, 300);
          } else {
            div.classList.add('yutuq');
            div.textContent = 'ü™ô';
            revealedCount++;
            const currentMultiplier = calculateMultiplier(revealedCount);
            multiplierDisplay.textContent = `Ko‚Äòpaytir: ${currentMultiplier}x`;
            updateCurrentWin();
          }
        });
      });
    }

    async function garovniOlish() {
      if (!isGameActive) {
        showNotification('‚ö†Ô∏è O‚Äòyin active emas!', 'error');
        return;
      }

      isGameActive = false;
      startButton.disabled = false;
      cashoutButton.disabled = true;

      const multiplier = parseFloat(calculateMultiplier(revealedCount));
      const bonus = Math.round(selectedBet * multiplier);

      try {
        userBalance += bonus;
        await updateBalanceOnServer(userBalance);
        showNotification(`üéâ ${revealedCount} kristal, ${multiplier}x, +${bonus} tanga!`, 'success');
      } catch (err) {
        userBalance -= bonus; // Xato bo‚Äòlsa, yutuqni qaytarish
        showNotification(`Yutuq hisoblanmadi: ${err.message}`, 'error');
      } finally {
        resetGame();
      }
    }

    function resetGame() {
      renderGrid();
      isGameActive = false;
      startButton.disabled = false;
      cashoutButton.disabled = true;
      selectedBet = 0;
      revealedCount = 0;
      multiplierDisplay.textContent = 'Ko‚Äòpaytir: 1.0x';
      currentWinDisplay.textContent = 'Joriy yutuq: 0 tanga';
    }

    betButtons.forEach(btn => {
      btn.addEventListener('click', () => {
        const amount = parseInt(btn.dataset.amount);
        if (!isNaN(amount) && amount >= 100) {
          selectedBet = amount;
          customBetInput.value = amount;
        }
      });
    });

    customBetInput.addEventListener('input', () => {
      const val = parseInt(customBetInput.value);
      if (!isNaN(val) && val >= 100) {
        selectedBet = val;
      } else {
        customBetInput.value = '';
        selectedBet = 0;
      }
    });

    startButton.addEventListener('click', startGame);
    cashoutButton.addEventListener('click', garovniOlish);

    window.onload = () => {
      console.log("Sahifa yuklandi, Telegram ID:", userId);
      fetchUserData();
      renderGrid();
    };
  </script>
</body>
</html>