<!DOCTYPE html>
<html lang="uz">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Cyberpunk Dashboard</title>
  <link href="https://fonts.googleapis.com/css2?family=Rajdhani:wght@400;700&display=swap" rel="stylesheet">
<style>
* {
  margin: 0;
  padding: 0;
  box-sizing: border-box;
}

body {
  min-height: 100vh;
  font-family: 'Rajdhani', sans-serif;
  background: url('/public/bg2.jpg') no-repeat center center fixed;
  background-size: cover;
  background-position: center;
  background-repeat: no-repeat;
  display: flex;
  flex-direction: column;
  color: #fff;
}

.user-info {
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding: 15px 20px;
  border-bottom: 1px solid #0ff;
  flex-wrap: wrap;
  gap: 10px;
}

.user-profile {
  display: flex;
  align-items: center;
  gap: 10px;
}

.avatar {
  width: 50px;
  height: 50px;
  border-radius: 50%;
  border: 2px solid #0ff;
}

.toggle-buttons {
  display: flex;
  justify-content: center;
  gap: 10px;
  margin: 20px;
  flex-wrap: wrap;
}

.toggle-buttons button {
  background: #1a1a2e;
  color: #fff;
  border: none;
  padding: 10px 20px;
  border-radius: 10px;
  cursor: pointer;
  font-weight: bold;
  min-width: 100px;
  transition: 0.3s;
  flex: 1 1 30%;
}

.toggle-buttons button:hover {
  background: #0ff;
  color: #000;
}

main {
  flex: 1;
  padding: 0 20px;
}

.section {
  display: none;
}

.section.active {
  display: block;
}

.task-item,
.reward-card {
  background: rgba(255, 255, 255, 0.05);
  padding: 15px;
  border-radius: 15px;
  margin-bottom: 10px;
  border: 1px solid #0ff;
  transition: 0.3s;
}

.task-item.completed,
.reward-card.claimed {
  border-color: #0f0;
  background: rgba(0, 255, 0, 0.1);
}

.reward-header {
  display: flex;
  align-items: center;
  justify-content: space-between;
  margin-bottom: 10px;
  gap: 10px;
}

.reward-header img {
  width: 35px;
  height: 35px;
}

.reward-coins {
  display: block;
  margin-bottom: 10px;
}

.claim-btn {
  padding: 6px 12px;
  background: linear-gradient(135deg, #0ff, #0f0);
  border: none;
  border-radius: 5px;
  cursor: pointer;
  color: #000;
  font-weight: bold;
  transition: 0.3s;
}

.claim-btn:disabled {
  background: #555;
  color: #aaa;
  cursor: not-allowed;
}

.claim-btn:hover:not(:disabled) {
  transform: scale(1.05);
  box-shadow: 0 0 10px #0ff;
}

.progress-bar {
  background: #333;
  border-radius: 20px;
  height: 10px;
  overflow: hidden;
  margin-top: 5px;
}

.progress {
  background: linear-gradient(90deg, #0ff, #0f0);
  height: 100%;
  transition: width 0.3s ease;
}

footer {
  position: fixed;
  bottom: 0;
  width: 100%;
  background: rgba(0, 0, 0, 0.9);
  color: #fff;
  text-align: center;
  padding: 10px;
  border-top: 1px solid #0ff;
  font-size: 14px;
}

@media (max-width: 480px) {
  .toggle-buttons button {
    flex: 1 1 30%;
    font-size: 14px;
    padding: 8px;
  }
}
</style>
</head>
<body>
  <div class="user-info">
    <div class="user-profile">
      <img id="avatar" src="/img/default.jpg" alt="Avatar" class="avatar">
      <div>
        <h3 id="name">Yuklanmoqda...</h3>
        <p id="level">--</p>
        <p id="xp">--</p>
      </div>
    </div>
    <div>
      <p id="rank">--</p>
      <p id="coins">Tanga: --</p>
    </div>
  </div>

  <div class="toggle-buttons">
    <button onclick="showSection('tasks')">üéØ Kundalik Vazifalar</button>
    <button onclick="showSection('ranks')">üèÜ Leagues</button>
    <button onclick="showSection('referrals')">üë• Ref</button>
  </div>

  <main>
    <div id="tasksSection" class="section active">
      <h2>üéØ Kundalik Vazifalar</h2>
      <div id="taskList"></div>
    </div>

    <div id="ranksSection" class="section">
      <h2>üèÜ Rank Mukofotlari</h2>
      <div id="rankList"></div>
    </div>

    <div id="referralsSection" class="section">
      <h2>üë• Referal Mukofotlari</h2>
      <div id="referralList"></div>
    </div>
  </main>

  <footer>
    üì¢ REKLAMA BU YERDA
  </footer>

  <script>
   // Telegram WebApp integratsiyasi
const tg = window.Telegram?.WebApp || {};
const userId = tg.initDataUnsafe?.user?.id || 123456; // Test uchun hardcoded ID

// Foydalanuvchi ma'lumotlarini yuklash
function loadUser() {
  console.log("Fetching user data for ID:", userId);
  if (!userId) {
    document.getElementById('name').textContent = 'Telegram ID topilmadi!';
    return;
  }

  fetch(`http://localhost:3000/api/user?telegram_id=${userId}`)
    .then(res => {
      console.log("Response:", res);
      if (!res.ok) throw new Error("Foydalanuvchi topilmadi");
      return res.json();
    })
    .then(data => {
      console.log("User data:", data);
      document.getElementById('name').textContent = data.name || 'Noma ºlum';
      document.getElementById('level').textContent = `Level: ${data.level || 1}`;
      document.getElementById('xp').textContent = `XP: ${data.xp || 0}`;
      document.getElementById('rank').textContent = `Rank: ${data.rank || 'Bronze'} | Score: ${data.score || 0}`;
      document.getElementById('coins').textContent = `Tanga: ${data.coins || 0}`;
      document.getElementById('avatar').src = data.avatar?.trim() ? data.avatar : '/img/default.jpg';
    })
    .catch(err => {
      console.error("Error:", err);
      document.getElementById('name').textContent = 'Xatolik!';
    });
}

// Kundalik vazifalar
const tasks = [
  { id: 1, name: 'Botni ishga tushiring', desc: 'Telegram botni ishga tushiring.', reward: 5, done: false },
  { id: 2, name: 'Profilni to‚Äòldiring', desc: 'Profilingizni to‚Äòldiring.', reward: 10, done: true },
  { id: 3, name: 'Kunlik kirish', desc: 'Bugun tizimga kiring.', reward: 3, done: false },
];

function loadTasks() {
  const list = document.getElementById('taskList');
  list.innerHTML = '';
  tasks.forEach(task => {
    const div = document.createElement('div');
    div.className = 'task-item' + (task.done ? ' completed' : '');
    div.innerHTML = `
      <h4>${task.name}</h4>
      <p>${task.desc}</p>
      <p>üéÅ Mukofot: ${task.reward} tanga</p>
      ${task.done ? '<p style="color:#0f0;">‚úÖ Bajarilgan</p>' : `<button onclick="completeTask(${task.id})" class="claim-btn">Bajarildi</button>`}
    `;
    list.appendChild(div);
  });
}

function completeTask(id) {
  const task = tasks.find(t => t.id === id);
  if (task) {
    task.done = true;
    alert('‚úÖ Vazifa bajarildi!');
    loadTasks();
  }
}

// Rank mukofotlari
const ranks = [
  { name: 'Silver', reward: 5000, progress: 100, claimed: false, img: '/img/photo_2025-07-14_22-54-47.jpg' },
  { name: 'Gold', reward: 10000, progress: 80, claimed: false, img: '/img/gold.png' },
  { name: 'Platinum', reward: 30000, progress: 30, claimed: false, img: '/img/platinum.png' },
];

function loadRanks() {
  const list = document.getElementById('rankList');
  list.innerHTML = '';
  ranks.forEach((rank, idx) => {
    const div = document.createElement('div');
    div.className = 'reward-card' + (rank.claimed ? ' claimed' : '');
    div.innerHTML = `
      <div class="reward-header">
        <img src="${rank.img}" alt="${rank.name}">
        <span>${rank.name}</span>
        ${rank.progress >= 100 && !rank.claimed
          ? `<button onclick="claimRank(${idx})" class="claim-btn">Claim</button>`
          : `<button disabled class="claim-btn">Claim</button>`}
      </div>
      <span class="reward-coins">ü™ô ${rank.reward.toLocaleString()}</span>
      <div class="progress-bar">
        <div class="progress" style="width:${rank.progress}%;"></div>
      </div>
    `;
    list.appendChild(div);
  });
}

function claimRank(idx) {
  ranks[idx].claimed = true;
  alert(`${ranks[idx].name} mukofoti olindi!`);
  loadRanks();
}

// Referral tizimi
let referrals = [
  { count: 1, reward: 2500, progress: 0, claimed: false, img: '/img/cat.png' },
  { count: 3, reward: 50000, progress: 0, claimed: false, img: '/img/cat.png' },
  { count: 10, reward: 200000, progress: 0, claimed: false, img: '/img/cat.png' },
];

function loadReferrals() {
  // Serverdan ma'lumotlarni olish (agar server mavjud bo'lmasa, lokal ma'lumotlar ishlatiladi)
  fetch(`api/referrals?telegram_id=${userId}`)
    .then(res => {
      if (!res.ok) throw new Error("Referral ma'lumotlari topilmadi");
      return res.json();
    })
    .then(data => {
      referrals = data; // Serverdan kelgan ma'lumotlarni yangilash
      renderReferrals();
    })
    .catch(err => {
      console.error("Referral yuklashda xatolik:", err);
      renderReferrals(); // Lokal ma'lumotlar bilan davom etish
    });
}

function renderReferrals() {
  const list = document.getElementById('referralList');
  list.innerHTML = '';
  referrals.forEach((ref, idx) => {
    const div = document.createElement('div');
    div.className = 'reward-card' + (ref.claimed ? ' claimed' : '');
    div.innerHTML = `
      <div class="reward-header">
        <img src="${ref.img}" alt="Invite ${ref.count} Friends">
        <span>Invite ${ref.count} Friends</span>
        ${ref.progress >= 100 && !ref.claimed
          ? `<button onclick="claimReferral(${idx})" class="claim-btn">Claim</button>`
          : `<button disabled class="claim-btn">Claim</button>`}
      </div>
      <span class="reward-coins">ü™ô ${ref.reward.toLocaleString()}</span>
      <div class="progress-bar">
        <div class="progress" style="width:${ref.progress}%;"></div>
      </div>
    `;
    list.appendChild(div);
  });
}

function claimReferral(idx) {
  referrals[idx].claimed = true;
  alert(`Referal mukofoti olindi! +${referrals[idx].reward} tanga`);
  // Serverga yangilash jo'natish (masalan, POST so'rovi)
  fetch(`api/referrals/${userId}`, {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({ index: idx, claimed: true })
  })
    .then(res => res.json())
    .then(() => loadReferrals())
    .catch(err => console.error("Claim saqlashda xatolik:", err));
}

// Referral havolasi generatsiyasi
function generateReferralLink() {
  const baseUrl = window.location.origin; // Joriy domen
  return `${baseUrl}/referral?ref=${userId}`;
}

// Referral havolasini ko'rsatish
function displayReferralLink() {
  const link = generateReferralLink();
  const referralSection = document.getElementById('referralsSection');
  const linkElement = document.createElement('p');
  linkElement.innerHTML = `
  <span style="color: #0ff; font-weight: bold; font-size: 16px;">Sizning referral havolangiz:</span>
  <div class="referral-link-container">
    <a href="${link}" target="_blank"">${link}</a>
  </div>
  <button onclick="copyToClipboard('${link}')" style="background: #1a1a2e; color: #0ff; border: 1px solid #0ff; padding: 5px 10px; border-radius: 5px; cursor: pointer; transition: background 0.3s;"
          onmouseover="this.style.background='#0ff'; this.style.color='#000';"
          onmouseout="this.style.background='#1a1a2e'; this.style.color='#0ff';">Nusxalash</button>
  <button onclick="shareReferral()" style="background: #1a1a2e; color: #0ff; border: 1px solid #0ff; padding: 5px 10px; border-radius: 5px; cursor: pointer; transition: background 0.3s;"
          onmouseover="this.style.background='#0ff'; this.style.color='#000';"
          onmouseout="this.style.background='#1a1a2e'; this.style.color='#0ff';">Ulashish</button>
`;
  referralSection.insertBefore(linkElement, referralSection.firstChild.nextSibling); // Sektsiya boshiga qo‚Äòshish
}

// Havolani nusxalash
function copyToClipboard(text) {
  navigator.clipboard.writeText(text).then(() => alert('Havola nusxalandi!'));
}

// Havolani ulashish
function shareReferral() {
  const link = generateReferralLink();
  if (navigator.share) {
    navigator.share({
      title: 'Mening referral havolam',
      text: 'Do‚Äòstlarimni taklif qiling va mukofot oling!',
      url: link,
    }).catch(err => console.error("Ulashishda xatolik:", err));
  } else {
    alert('Ushbu brauzerda ulashish imkoni yo‚Äòq. Havolani nusxalab ulashing: ' + link);
  }
}

// Referral progressni yangilash (masalan, do'stlar qo'shilganda)
function updateReferralProgress(referredUserId) {
  fetch(`api/referrals/update?telegram_id=${userId}&referred_id=${referredUserId}`, {
    method: 'POST'
  })
    .then(res => res.json())
    .then(data => {
      referrals = data.referrals; // Yangilangan ma'lumotlarni olish
      renderReferrals();
    })
    .catch(err => console.error("Progress yangilashda xatolik:", err));
}

// Bo‚Äòlimlarni ko‚Äòrsatish
function showSection(section) {
  document.querySelectorAll('.section').forEach(s => s.classList.remove('active'));
  document.getElementById(section + 'Section').classList.add('active');
}

// Sahifa yuklanganda barcha ma'lumotlarni yuklash
window.onload = () => {
  loadUser();
  loadTasks();
  loadRanks();
  loadReferrals();
  displayReferralLink();
};
  </script>
</body>
</html>